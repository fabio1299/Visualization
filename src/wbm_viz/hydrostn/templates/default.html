{% extends "base.html" %}
{% load static %}
{% block header %}
    {% load leaflet_tags %}
    {% leaflet_js %}
    {% leaflet_css %}
{% endblock %}

{% block style %}
    <style>
        #country_map {
        height: 800px;
        }

        .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255,255,255,0.8);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 5px;
        }
        .info h4 {
            margin: 0 0 5px;
            color: #777;
        }
    </style>
{% endblock %}

{% block controls %}
    <div class="list-group list-group-flush">
        <button class="list-group-item list-group-item-warning list-group-item-action bg-light" id="random-button">Random Subbasin</button>
    </div>
{% endblock %}

{% block content %}
        <div class="row">

            <div class="map col-lg-12 " id="country_map">
                {% leaflet_map "country_map" callback="country_map_init" %}
            </div>

        </div>
{% endblock %}

{% block script %}



<script type="text/javascript">

    document.getElementById("random-button").onclick = function () {
        const random_num = Math.floor(Math.random() * Math.floor({{ subbasin_count }}));

        location.href = `../${random_num}`
    }
    function country_style(feature){
        return {
            color: '#FFFF00',
            fill: false,
            weight: 2,
        }
    }

    function country_map_init(map, options){
        const country = L.geoJSON({{ country_geom.geojson |safe }}, {style: country_style});
        country.addTo(map)
        {# Restrict bounds to current country #}
        map.setMaxBounds(country.getBounds());
        map.fitBounds(country.getBounds());

        function map_redirect(e) {
                let ptstr = e.latlng.toString()
                let lat = e.latlng.lat
                let lon = e.latlng.lng
                let url = '<a href="{% url 'station_redirect' country 1234 5678 %}">Go to ' + ptstr + '<br></a>'
                url = url.replace('1234', lat)
                url = url.replace('5678', lon)
                return url
            }

        let info = L.control({position: 'bottomleft'});
        info.onAdd = function (map) {
            this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
            this.update();
            return this._div;};
        info.update = function (props) {
            this._div.innerHTML =  'Click to navigate <br> within yellow outline <br> of {{ country }}'};
        info.addTo(map);


            var popup = L.popup();

            function onMapClick(e) {
                let in_country = leafletPip.pointInLayer(e.latlng, country, [true]);

                if (in_country.length > 0){
                    popup
                    .setLatLng(e.latlng)
                    .setContent(map_redirect(e))
                    .openOn(map);
                }
            }

            map.on('click', onMapClick);
    }
</script>
{% endblock %}